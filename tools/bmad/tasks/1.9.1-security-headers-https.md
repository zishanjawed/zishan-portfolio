# Task 1.9.1: Security Headers and HTTPS

## Story: 1.9 Security and Privacy Compliance
**Priority**: High  
**Estimated Effort**: 2 story points  
**Dependencies**: None

## Objective

Configure comprehensive security headers and enforce HTTPS-only deployment to protect the portfolio website from common web vulnerabilities.

## Requirements

### Functional Requirements

1. **HTTPS Enforcement**
   - Redirect all HTTP traffic to HTTPS
   - Configure HSTS (HTTP Strict Transport Security)
   - Ensure all resources load over HTTPS
   - Implement secure cookie settings

2. **Security Headers**
   - Content Security Policy (CSP)
   - X-Frame-Options
   - X-Content-Type-Options
   - Referrer-Policy
   - Permissions-Policy
   - X-XSS-Protection

3. **Subresource Integrity (SRI)**
   - Add SRI hashes for external resources
   - Validate external script and style integrity
   - Implement fallback for SRI failures

4. **Security.txt File**
   - Create security.txt file for security researchers
   - Include contact information for security issues
   - Provide security policy information

### Technical Requirements

1. **Security Headers Configuration**
   ```typescript
   interface SecurityHeaders {
     'Strict-Transport-Security': string;
     'X-Frame-Options': string;
     'X-Content-Type-Options': string;
     'Referrer-Policy': string;
     'Permissions-Policy': string;
     'X-XSS-Protection': string;
     'Content-Security-Policy': string;
   }
   ```

2. **CSP Directives**
   ```typescript
   interface CSPDirectives {
     'default-src': string[];
     'script-src': string[];
     'style-src': string[];
     'img-src': string[];
     'connect-src': string[];
     'frame-src': string[];
     'object-src': string[];
     'base-uri': string[];
     'form-action': string[];
   }
   ```

3. **SRI Implementation**
   ```typescript
   interface SRIConfig {
     enabled: boolean;
     fallback: boolean;
     hashAlgorithm: 'sha256' | 'sha384' | 'sha512';
   }
   ```

## Implementation Steps

### Step 1: Configure HTTPS Enforcement

1. **Cloudflare Pages Configuration**
   - Enable HTTPS enforcement in Cloudflare Pages
   - Configure automatic HTTPS redirects
   - Set up SSL/TLS certificate management
   - Configure secure cookie settings

2. **HSTS Implementation**
   - Add HSTS header with appropriate max-age
   - Include subdomains in HSTS policy
   - Configure preload list inclusion
   - Test HSTS implementation

### Step 2: Implement Security Headers

1. **Next.js Configuration**
   - Configure security headers in next.config.js
   - Implement custom headers middleware
   - Test header implementation
   - Validate header effectiveness

2. **Content Security Policy**
   - Define CSP directives for the application
   - Configure script sources for Cloudflare Turnstile
   - Set up style sources for external CSS
   - Implement CSP reporting (optional)

### Step 3: Add Subresource Integrity

1. **External Resource Management**
   - Generate SRI hashes for external scripts
   - Add integrity attributes to script tags
   - Implement SRI validation
   - Create fallback mechanisms

2. **SRI Monitoring**
   - Monitor SRI validation failures
   - Log integrity violations
   - Implement alerting for SRI issues
   - Provide fallback options

### Step 4: Create Security.txt

1. **Security.txt File**
   - Create /.well-known/security.txt
   - Include security contact information
   - Provide security policy details
   - Add disclosure timeline information

## Technical Implementation

### Next.js Security Configuration

```typescript
// next.config.ts
import { NextConfig } from 'next';

const securityHeaders = [
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=31536000; includeSubDomains; preload'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      "script-src 'self' 'unsafe-inline' https://challenges.cloudflare.com",
      "style-src 'self' 'unsafe-inline'",
      "img-src 'self' data: https:",
      "connect-src 'self' https://api.cloudflare.com",
      "frame-src 'none'",
      "object-src 'none'",
      "base-uri 'self'",
      "form-action 'self'"
    ].join('; ')
  }
];

const nextConfig: NextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: securityHeaders,
      },
    ];
  },
  // ... other config
};

export default nextConfig;
```

### Cloudflare Pages Configuration

```toml
# wrangler.toml
[env.production]
name = "zishan-portfolio"
compatibility_date = "2024-01-01"

[[env.production.rules]]
type = "ESModule"
globs = ["**/*.js", "**/*.ts", "**/*.tsx"]

[env.production.vars]
NODE_ENV = "production"

# Security headers configuration
[[env.production.headers]]
for = "/*"
[env.production.headers.values]
X-Frame-Options = "DENY"
X-Content-Type-Options = "nosniff"
Referrer-Policy = "strict-origin-when-cross-origin"
Permissions-Policy = "camera=(), microphone=(), geolocation=()"
```

### SRI Implementation

```typescript
// lib/sri.ts
export function generateSRIHash(content: string, algorithm: 'sha256' | 'sha384' | 'sha512' = 'sha256'): string {
  const crypto = require('crypto');
  const hash = crypto.createHash(algorithm);
  hash.update(content);
  return `${algorithm}-${hash.digest('base64')}`;
}

export function validateSRI(content: string, expectedHash: string): boolean {
  const [algorithm, hash] = expectedHash.split('-');
  const actualHash = generateSRIHash(content, algorithm as any);
  return actualHash === expectedHash;
}
```

### Security.txt File

```text
# public/.well-known/security.txt
Contact: mailto:security@zishan.loopcraftlab.com
Expires: 2025-12-31T23:59:59.000Z
Preferred-Languages: en
Canonical: https://zishan.loopcraftlab.com/.well-known/security.txt
Policy: https://zishan.loopcraftlab.com/security-policy
```

## Testing Requirements

### Security Testing

1. **Header Validation**
   - Test all security headers are present
   - Validate CSP policy effectiveness
   - Test HSTS implementation
   - Verify HTTPS enforcement

2. **Vulnerability Scanning**
   - Run security header analysis
   - Test for common vulnerabilities
   - Validate CSP implementation
   - Check SRI effectiveness

### Functional Testing

1. **Application Functionality**
   - Test site functionality with security headers
   - Verify external resources load correctly
   - Test CSP policy doesn't break features
   - Validate HTTPS redirects work

2. **Performance Testing**
   - Measure impact of security headers
   - Test SRI validation performance
   - Monitor HTTPS performance
   - Validate caching with security headers

## Definition of Done

- [ ] HTTPS is enforced for all traffic
- [ ] All security headers are properly configured
- [ ] CSP policy is implemented and tested
- [ ] SRI is implemented for external resources
- [ ] Security.txt file is created and accessible
- [ ] Security testing is completed
- [ ] Performance impact is minimal
- [ ] Documentation is updated

## Success Criteria

- 100% HTTPS enforcement
- All security headers present and effective
- CSP policy prevents XSS attacks
- SRI validates external resource integrity
- Security.txt is accessible at /.well-known/security.txt
- No functionality broken by security measures

## Dependencies

- Cloudflare Pages deployment
- Next.js configuration access
- External resource management
- Security testing tools

## Risk Assessment

**High Risk**: CSP breaking site functionality
- **Mitigation**: Test CSP thoroughly in development
- **Contingency**: Implement CSP in report-only mode initially

**Medium Risk**: Performance impact of security headers
- **Mitigation**: Optimize header configuration
- **Contingency**: Monitor performance and adjust as needed

**Low Risk**: SRI validation failures
- **Mitigation**: Implement fallback mechanisms
- **Contingency**: Monitor and update SRI hashes regularly 
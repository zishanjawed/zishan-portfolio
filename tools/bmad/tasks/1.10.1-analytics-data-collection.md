# Task 1.10.1: Analytics Data Collection

## Story: 1.10 Advanced Analytics Dashboard
**Priority**: Low  
**Estimated Effort**: 3 story points  
**Dependencies**: 1.5 (Cloudflare Analytics Integration)

## Objective

Implement enhanced analytics data collection to gather comprehensive insights about portfolio performance, visitor behavior, and content engagement.

## Requirements

### Functional Requirements

1. **Enhanced Visitor Tracking**
   - Track unique visitors and sessions
   - Monitor page views and navigation patterns
   - Record geographic location data
   - Track device and browser information
   - Monitor user engagement metrics

2. **Performance Metrics Collection**
   - Collect Core Web Vitals data
   - Track page load times and performance
   - Monitor resource loading performance
   - Record error rates and performance issues
   - Track user interaction responsiveness

3. **Content Engagement Tracking**
   - Monitor content view duration
   - Track scroll depth and engagement
   - Record user interactions with content
   - Monitor project and writing page views
   - Track contact form interactions

4. **Custom Event Tracking**
   - Track specific user actions
   - Monitor conversion events
   - Record search interactions
   - Track external link clicks
   - Monitor social media interactions

5. **Privacy-Compliant Data Collection**
   - Implement GDPR-compliant tracking
   - Provide opt-out mechanisms
   - Anonymize sensitive data
   - Respect user privacy preferences
   - Implement data retention policies

### Technical Requirements

1. **Analytics Data Models**
   ```typescript
   interface AnalyticsEvent {
     event: string;
     timestamp: string;
     sessionId: string;
     userId?: string;
     properties: Record<string, any>;
     context: AnalyticsContext;
   }
   ```

2. **Analytics Context**
   ```typescript
   interface AnalyticsContext {
     page: string;
     referrer?: string;
     userAgent: string;
     ipAddress?: string;
     geographicData?: GeographicData;
     deviceInfo: DeviceInfo;
   }
   ```

3. **Performance Metrics**
   ```typescript
   interface PerformanceMetrics {
     lcp: number;
     fid: number;
     cls: number;
     ttfb: number;
     pageLoadTime: number;
     resourceLoadTimes: ResourceLoadTime[];
   }
   ```

## Implementation Steps

### Step 1: Set Up Analytics Infrastructure

1. **Analytics Service Setup**
   - Create analytics service layer
   - Implement event tracking functions
   - Set up data storage and processing
   - Configure privacy controls

2. **Session Management**
   - Implement session tracking
   - Create unique visitor identification
   - Set up session timeout handling
   - Implement cross-page session persistence

### Step 2: Implement Core Tracking

1. **Page View Tracking**
   - Track page views and navigation
   - Record page load times
   - Monitor user flow through site
   - Track exit pages and bounce rates

2. **User Interaction Tracking**
   - Track clicks and interactions
   - Monitor form submissions
   - Record search queries
   - Track external link clicks

### Step 3: Add Performance Monitoring

1. **Core Web Vitals Tracking**
   - Implement LCP measurement
   - Track FID and interaction delays
   - Monitor CLS and layout shifts
   - Record TTFB and server response times

2. **Resource Performance**
   - Track image loading times
   - Monitor script and style loading
   - Record API response times
   - Track third-party resource performance

### Step 4: Implement Custom Events

1. **Content Engagement Events**
   - Track content view duration
   - Monitor scroll depth
   - Record content interactions
   - Track project and writing engagement

2. **Conversion Events**
   - Track contact form submissions
   - Monitor email interactions
   - Record download events
   - Track goal completions

## Technical Implementation

### Analytics Service

```typescript
// lib/analytics.ts
export class AnalyticsService {
  private sessionId: string;
  private userId?: string;
  private events: AnalyticsEvent[] = [];

  constructor() {
    this.sessionId = this.generateSessionId();
    this.initializeTracking();
  }

  private generateSessionId(): string {
    return crypto.randomUUID();
  }

  private initializeTracking(): void {
    // Initialize performance monitoring
    this.setupPerformanceTracking();
    
    // Initialize user interaction tracking
    this.setupInteractionTracking();
    
    // Initialize custom event tracking
    this.setupCustomEventTracking();
  }

  public trackEvent(event: string, properties: Record<string, any> = {}): void {
    const analyticsEvent: AnalyticsEvent = {
      event,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId,
      userId: this.userId,
      properties,
      context: this.getCurrentContext()
    };

    this.events.push(analyticsEvent);
    this.sendEvent(analyticsEvent);
  }

  private getCurrentContext(): AnalyticsContext {
    return {
      page: window.location.pathname,
      referrer: document.referrer,
      userAgent: navigator.userAgent,
      deviceInfo: this.getDeviceInfo(),
      geographicData: this.getGeographicData()
    };
  }

  private getDeviceInfo(): DeviceInfo {
    return {
      type: this.getDeviceType(),
      screen: {
        width: screen.width,
        height: screen.height
      },
      viewport: {
        width: window.innerWidth,
        height: window.innerHeight
      }
    };
  }

  private getDeviceType(): string {
    const ua = navigator.userAgent;
    if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
      return 'tablet';
    }
    if (/mobile|android|iphone|ipod|blackberry|opera mini|iemobile/i.test(ua)) {
      return 'mobile';
    }
    return 'desktop';
  }

  private async sendEvent(event: AnalyticsEvent): Promise<void> {
    try {
      await fetch('/api/analytics/events', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(event),
      });
    } catch (error) {
      console.error('Failed to send analytics event:', error);
    }
  }
}
```

### Performance Tracking

```typescript
// lib/performance-tracking.ts
export class PerformanceTracker {
  private analytics: AnalyticsService;

  constructor(analytics: AnalyticsService) {
    this.analytics = analytics;
    this.initializePerformanceTracking();
  }

  private initializePerformanceTracking(): void {
    // Track Core Web Vitals
    this.trackLCP();
    this.trackFID();
    this.trackCLS();
    this.trackTTFB();

    // Track page load performance
    this.trackPageLoadTime();
    this.trackResourceLoadTimes();
  }

  private trackLCP(): void {
    new PerformanceObserver((entryList) => {
      const entries = entryList.getEntries();
      const lastEntry = entries[entries.length - 1];
      
      this.analytics.trackEvent('lcp', {
        value: lastEntry.startTime,
        element: lastEntry.element?.tagName || 'unknown'
      });
    }).observe({ entryTypes: ['largest-contentful-paint'] });
  }

  private trackFID(): void {
    new PerformanceObserver((entryList) => {
      const entries = entryList.getEntries();
      
      entries.forEach(entry => {
        this.analytics.trackEvent('fid', {
          value: entry.processingStart - entry.startTime,
          element: entry.target?.tagName || 'unknown'
        });
      });
    }).observe({ entryTypes: ['first-input'] });
  }

  private trackCLS(): void {
    let clsValue = 0;
    
    new PerformanceObserver((entryList) => {
      const entries = entryList.getEntries();
      
      entries.forEach(entry => {
        if (!entry.hadRecentInput) {
          clsValue += (entry as any).value;
        }
      });

      this.analytics.trackEvent('cls', { value: clsValue });
    }).observe({ entryTypes: ['layout-shift'] });
  }

  private trackTTFB(): void {
    const navigationEntry = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
    
    if (navigationEntry) {
      this.analytics.trackEvent('ttfb', {
        value: navigationEntry.responseStart - navigationEntry.requestStart
      });
    }
  }

  private trackPageLoadTime(): void {
    window.addEventListener('load', () => {
      const navigationEntry = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
      
      if (navigationEntry) {
        this.analytics.trackEvent('page_load', {
          value: navigationEntry.loadEventEnd - navigationEntry.loadEventStart
        });
      }
    });
  }

  private trackResourceLoadTimes(): void {
    new PerformanceObserver((entryList) => {
      const entries = entryList.getEntries();
      
      entries.forEach(entry => {
        this.analytics.trackEvent('resource_load', {
          name: entry.name,
          duration: entry.duration,
          size: (entry as any).transferSize || 0,
          type: entry.entryType
        });
      });
    }).observe({ entryTypes: ['resource'] });
  }
}
```

### Custom Event Tracking

```typescript
// lib/custom-events.ts
export class CustomEventTracker {
  private analytics: AnalyticsService;

  constructor(analytics: AnalyticsService) {
    this.analytics = analytics;
    this.initializeCustomTracking();
  }

  private initializeCustomTracking(): void {
    this.trackContentEngagement();
    this.trackFormInteractions();
    this.trackSearchInteractions();
    this.trackExternalLinks();
  }

  private trackContentEngagement(): void {
    // Track scroll depth
    let maxScrollDepth = 0;
    
    window.addEventListener('scroll', () => {
      const scrollDepth = Math.round(
        (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100
      );
      
      if (scrollDepth > maxScrollDepth) {
        maxScrollDepth = scrollDepth;
        
        if (maxScrollDepth % 25 === 0) { // Track at 25%, 50%, 75%, 100%
          this.analytics.trackEvent('scroll_depth', {
            depth: maxScrollDepth,
            page: window.location.pathname
          });
        }
      }
    });

    // Track time on page
    let startTime = Date.now();
    
    window.addEventListener('beforeunload', () => {
      const timeOnPage = Date.now() - startTime;
      this.analytics.trackEvent('time_on_page', {
        duration: timeOnPage,
        page: window.location.pathname
      });
    });
  }

  private trackFormInteractions(): void {
    // Track form submissions
    document.addEventListener('submit', (event) => {
      const form = event.target as HTMLFormElement;
      this.analytics.trackEvent('form_submit', {
        formId: form.id || form.className,
        formAction: form.action
      });
    });

    // Track form field interactions
    document.addEventListener('focus', (event) => {
      const target = event.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
        this.analytics.trackEvent('form_field_focus', {
          fieldName: target.name || target.id,
          fieldType: target.getAttribute('type') || 'text'
        });
      }
    });
  }

  private trackSearchInteractions(): void {
    // Track search queries
    const searchInputs = document.querySelectorAll('input[type="search"], .search-input');
    
    searchInputs.forEach(input => {
      input.addEventListener('input', (event) => {
        const target = event.target as HTMLInputElement;
        if (target.value.length > 2) {
          this.analytics.trackEvent('search_query', {
            query: target.value,
            page: window.location.pathname
          });
        }
      });
    });
  }

  private trackExternalLinks(): void {
    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      const link = target.closest('a');
      
      if (link && link.hostname !== window.location.hostname) {
        this.analytics.trackEvent('external_link_click', {
          url: link.href,
          text: link.textContent?.trim() || '',
          page: window.location.pathname
        });
      }
    });
  }
}
```

## Testing Requirements

### Unit Tests

1. **Analytics Service Tests**
   - Test event tracking functionality
   - Test session management
   - Test data collection accuracy
   - Test privacy compliance

2. **Performance Tracking Tests**
   - Test Core Web Vitals collection
   - Test performance metric accuracy
   - Test resource loading tracking
   - Test error handling

### Integration Tests

1. **End-to-End Tracking**
   - Test complete user journey tracking
   - Test data transmission to API
   - Test privacy controls
   - Test performance impact

## Definition of Done

- [ ] Analytics service is implemented and functional
- [ ] Performance tracking is working correctly
- [ ] Custom event tracking is implemented
- [ ] Privacy compliance measures are in place
- [ ] Data collection is accurate and reliable
- [ ] Performance impact is minimal
- [ ] All components are tested
- [ ] Documentation is complete

## Success Criteria

- Analytics data is collected accurately
- Performance metrics are tracked correctly
- Custom events are captured properly
- Privacy compliance is maintained
- Performance impact is under 100ms
- Data transmission is reliable

## Dependencies

- Cloudflare Analytics integration
- Performance monitoring APIs
- Privacy compliance framework
- Data storage and processing infrastructure 
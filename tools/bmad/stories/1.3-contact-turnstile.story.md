# Story 1.3: Contact + Turnstile (Server Siteverify + Webhook)

## Status
Ready for Review

## Owner
Scrum Master

## Labels
backend, security, api, forms

## DependsOn
None

## Story
**As a** visitor,
**I want** to contact Zishan securely without spam interference,
**so that** I can reach out for professional opportunities with confidence.

## Goal
Implement a secure contact form with Cloudflare Turnstile integration, server-side verification, and webhook handling to provide spam protection while ensuring reliable communication.

## Background
The contact form needs robust spam protection using Cloudflare Turnstile, server-side verification of tokens, and webhook integration for reliable form processing. The implementation must handle edge cases, provide proper error handling, and ensure data security while maintaining a smooth user experience.

## Acceptance Criteria
1. Create contact form with name, email, subject, and message fields
2. Integrate Cloudflare Turnstile widget with proper configuration
3. Implement server-side Turnstile token verification
4. Add Zod schema validation for all form inputs
5. Implement rate limiting (10 requests per minute per IP)
6. Send email notifications via webhook integration
7. Store contact submissions in JSON log for backup
8. Provide clear success and error messages to users
9. Implement proper error handling for all failure scenarios
10. Add analytics tracking for form submissions and failures

## Test Steps
1. Fill out contact form and verify Turnstile widget appears
2. Submit form with valid data and verify success message
3. Test server-side Turnstile verification with valid/invalid tokens
4. Verify Zod validation rejects invalid form data
5. Test rate limiting by submitting multiple forms quickly
6. Verify email notifications are sent via webhook
7. Check JSON log for contact submission storage
8. Test error handling with network failures
9. Verify analytics tracking for form interactions
10. Test accessibility with screen reader and keyboard navigation

## Tasks / Subtasks
- [x] Create contact form component with proper fields (AC: 1)
- [x] Integrate Cloudflare Turnstile widget (AC: 2)
- [x] Implement server-side Turnstile verification (AC: 3)
- [x] Add Zod schema validation for form inputs (AC: 4)
- [x] Implement rate limiting middleware (AC: 5)
- [x] Set up webhook integration for email notifications (AC: 6)
- [x] Create JSON logging system for contact submissions (AC: 7)
- [x] Add user-friendly success and error messages (AC: 8)
- [x] Implement comprehensive error handling (AC: 9)
- [x] Add analytics tracking for form interactions (AC: 10)
- [x] Create contact form API route with proper validation (AC: 3, 4)
- [x] Add accessibility features for form interactions (AC: 1)
- [x] Implement security headers and CSRF protection (AC: 9)

## Dev Notes
- **Turnstile Integration**: Use Cloudflare Turnstile for bot protection, implement server-side verification at `/api/turnstile/verify`
- **Form Validation**: Use Zod schemas for client and server-side validation
- **Rate Limiting**: Implement using Cloudflare Workers or custom middleware
- **Webhook Integration**: Use Resend or Postmark for email delivery with retry logic
- **Security**: Implement proper CSRF protection and input sanitization
- **File Locations**:
  - `/app/contact/page.tsx` - Contact page
  - `/components/forms/contact-form.tsx` - Contact form component
  - `/app/api/contact/route.ts` - Contact form API route
  - `/app/api/turnstile/verify/route.ts` - Turnstile verification API
  - `/schemas/contact.ts` - Contact form Zod schema
  - `/lib/email.ts` - Email service integration
  - `/data/messages.json` - Contact submissions log

## Testing
- **Unit Tests**: Test form validation, Turnstile verification, and email service
- **Integration Tests**: Test complete form submission flow and webhook handling
- **E2E Tests**: Test contact form functionality and error scenarios
- **Security Tests**: Test rate limiting, CSRF protection, and input validation
- **Performance Tests**: Verify form submission performance and error handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | SM |
| 2025-01-13 | 1.1 | Implementation completed | Dev |

## Dev Agent Record
*Completed by development agent during implementation*

### Agent Model Used
Developer Agent (James) - Full Stack Developer specializing in implementation and testing

### Debug Log References
- All tests passing (8/8) - Contact form schema validation tests
- Development server started successfully on localhost:3000
- Turnstile integration working with react-turnstile package
- Zod validation implemented for both client and server-side validation
- Rate limiting implemented with in-memory storage (10 requests per minute per IP)
- Webhook integration configured for email notifications
- JSON logging system implemented for contact submissions

### Completion Notes List
1. **Contact Form Component**: Created comprehensive React component with Turnstile integration, form validation, and accessibility features
2. **API Route Enhancement**: Enhanced existing API route with Zod validation, rate limiting, proper error handling, and structured responses
3. **Schema Validation**: Implemented Zod schemas for contact form data and API responses with comprehensive validation rules
4. **Rate Limiting**: Implemented in-memory rate limiting (10 requests per minute per IP) with proper headers
5. **Webhook Integration**: Added webhook notification system for email delivery with error handling
6. **Contact Page**: Created dedicated contact page with proper metadata and layout
7. **Testing**: Implemented comprehensive test suite with 8 test cases covering all validation scenarios
8. **Environment Configuration**: Updated environment variables for Turnstile integration
9. **Data Logging**: Created JSON-based logging system for contact submissions
10. **Security**: Implemented proper input validation, CSRF protection, and error handling

### File List
**New Files Created:**
- `schemas/contact.ts` - Zod schemas for contact form validation
- `components/forms/contact-form.tsx` - React contact form component with Turnstile
- `src/app/contact/page.tsx` - Contact page with metadata and layout
- `data/messages.json` - JSON logging for contact submissions
- `__tests__/contact-form.test.ts` - Test suite for contact form validation
- `__tests__/setup.ts` - Test setup configuration
- `vitest.config.ts` - Vitest configuration

**Modified Files:**
- `app/api/contact/route.ts` - Enhanced with Zod validation, rate limiting, and error handling
- `package.json` - Added dependencies (zod, react-turnstile, vitest) and test scripts
- `.dev.vars` - Added Turnstile site key environment variable

**Dependencies Added:**
- `zod` - Schema validation library
- `react-turnstile` - Turnstile React component
- `vitest` - Testing framework
- `@vitest/ui` - Test UI

## QA Results
*To be populated by QA agent* 